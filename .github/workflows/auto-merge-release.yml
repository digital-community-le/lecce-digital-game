name: Auto-merge Release PR

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  actions: write
  checks: write

jobs:
  auto-merge-release-pr:
    # Trigger solo per PR di release o commenti su PR di release
    if: |
      (github.event_name == 'pull_request' &&
       startsWith(github.event.pull_request.title, 'chore') && 
       contains(github.event.pull_request.title, 'release') &&
       github.event.pull_request.user.login == 'github-actions[bot]') ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '‚úÖ **Pre-validation passed**') &&
       github.event.comment.user.login == 'github-actions[bot]')
    runs-on: ubuntu-latest
    steps:
      - name: Get PR details
        id: pr-info
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            let prNumber, prData;

            if (context.eventName === 'pull_request') {
              prNumber = context.payload.pull_request.number;
              prData = context.payload.pull_request;
            } else if (context.eventName === 'issue_comment') {
              prNumber = context.payload.issue.number;
              // Fetch PR data
              const { data } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
              prData = data;
            }

            // Verifica che sia una PR di release
            const isReleasePR = prData.title.startsWith('chore') && 
                               prData.title.includes('release') &&
                               prData.user.login === 'github-actions[bot]';

            if (!isReleasePR) {
              console.log('‚ùå Not a release PR, skipping');
              return;
            }

            console.log(`‚úÖ Processing release PR #${prNumber}: ${prData.title}`);

            // Controlla se ci sono commenti che indicano validazione passata
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const validationPassed = comments.some(comment => 
              comment.body.includes('‚úÖ **Pre-validation passed**')
            );

            const validationFailed = comments.some(comment => 
              comment.body.includes('‚ö†Ô∏è **Pre-validation failed**')
            );

            console.log(`PR #${prNumber} mergeable: ${prData.mergeable}`);
            console.log(`Validation passed: ${validationPassed}`);
            console.log(`Validation failed: ${validationFailed}`);

            const ready = prData.mergeable && validationPassed && !validationFailed;

            return {
              prNumber,
              ready,
              mergeable: prData.mergeable,
              validationPassed,
              validationFailed,
              title: prData.title
            };

      - name: Wait for checks if needed
        if: fromJSON(steps.pr-info.outputs.result).ready
        run: |
          echo "‚è≥ Waiting 30 seconds for any pending checks to complete..."
          sleep 30

      - name: Auto-approve and merge
        if: fromJSON(steps.pr-info.outputs.result).ready
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prInfo = ${{ steps.pr-info.outputs.result }};
            const prNumber = prInfo.prNumber;

            console.log(`üöÄ Auto-merging PR #${prNumber}...`);

            try {
              // 1. Approva la PR
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                event: 'APPROVE',
                body: 'ü§ñ Auto-approved by Release workflow - Pre-validation passed'
              });
              
              console.log(`‚úÖ PR #${prNumber} approved`);

              // 2. Direct merge (simplified approach)
              console.log(`üîÑ Proceeding with direct merge for PR #${prNumber}...`);
              
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash',
                commit_title: `üöÄ Release: ${prInfo.title}`,
                commit_message: 'Automatically merged by Release workflow'
              });

              console.log(`‚úÖ PR #${prNumber} merged successfully`);
              
              // Prova a commentare il successo
              try {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: `üöÄ **Release PR merged successfully!**
                  
                  ‚úÖ Pre-validation passed
                  ‚úÖ PR approved and merged automatically
                  ‚úÖ Deployment pipeline will start shortly
                  
                  **Next steps:**
                  - Monitor deployment in the Actions tab
                  - New release will be tagged automatically`
                });
                console.log(`‚úÖ Success comment posted to PR #${prNumber}`);
              } catch (commentError) {
                console.log(`‚ö†Ô∏è Could not post success comment: ${commentError.message}`);
              }
              
            } catch (error) {
              console.error('‚ùå Failed to process release PR:', error.message);
              
              // Prova a commentare l'errore
              try {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: `‚ùå **Auto-merge failed**
                  
                  **Error:** ${error.message}
                  
                  **Manual action required:**
                  1. Check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details
                  2. Manually review and merge this PR if appropriate
                  3. Consider investigating the auto-merge setup`
                });
                console.log(`‚úÖ Error comment posted to PR #${prNumber}`);
              } catch (commentError) {
                console.log(`‚ö†Ô∏è Could not post error comment: ${commentError.message}`);
              }
              
              core.setFailed(`Auto-merge failed: ${error.message}`);
            }

      - name: Comment if not ready
        if: steps.pr-info.outputs.result && !fromJSON(steps.pr-info.outputs.result).ready
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prInfo = ${{ steps.pr-info.outputs.result }};
            const prNumber = prInfo.prNumber;

            let reasons = [];
            if (!prInfo.mergeable) reasons.push('PR is not in mergeable state');
            if (!prInfo.validationPassed) reasons.push('Pre-validation has not passed yet');
            if (prInfo.validationFailed) reasons.push('Pre-validation failed');

            console.log(`‚è≥ PR #${prNumber} not ready for auto-merge: ${reasons.join(', ')}`);

            // Prova a commentare lo stato di non pronto
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `‚è≥ **Auto-merge not ready**
                
                **Reasons:**
                ${reasons.map(r => `- ‚ùå ${r}`).join('\n')}
                
                **What happens next:**
                - This workflow will retry when PR is updated or commented
                - Once conditions are met, auto-merge will be enabled automatically
                - You can also merge manually if needed
                
                **Troubleshooting:**
                - Check if pre-validation workflow is still running
                - Verify there are no merge conflicts
                - Look for validation failure comments above`
              });
              console.log(`‚úÖ Not ready comment posted to PR #${prNumber}`);
            } catch (commentError) {
              console.log(`‚ö†Ô∏è Could not post not ready comment: ${commentError.message}`);
            }
