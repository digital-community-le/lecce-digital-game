name: Debug Events Logger

# Trigger on common events to log what triggered the workflow
on:
  push:
  pull_request:
    types: [opened, synchronize, reopened, closed]
  issues:
    types: [opened, edited, closed]
  issue_comment:
    types: [created, edited]
  pull_request_review_comment:
    types: [created, edited]
  release:
    types: [published, edited]
  workflow_run:
    types: [completed]
  workflow_dispatch: # Manual trigger

permissions:
  contents: read

jobs:
  debug-event:
    runs-on: ubuntu-latest
    steps:
      - name: Log Event Details
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('ğŸ” DEBUG EVENT LOGGER');
            console.log('='.repeat(50));

            // Log basic event information
            console.log(`ğŸ“… Timestamp: ${new Date().toISOString()}`);
            console.log(`ğŸ¯ Event Name: ${context.eventName}`);
            console.log(`ğŸ·ï¸  Action: ${context.payload.action || 'N/A'}`);
            console.log(`ğŸ‘¤ Actor: ${context.actor}`);
            console.log(`ğŸ“‚ Repository: ${context.repo.owner}/${context.repo.repo}`);
            console.log(`ğŸŒ¿ Branch/Ref: ${context.ref || 'N/A'}`);
            console.log(`ğŸ”— SHA: ${context.sha || 'N/A'}`);
            console.log(`ğŸ†” Run ID: ${context.runId}`);
            console.log(`ğŸ”¢ Run Number: ${context.runNumber}`);

            console.log('\nğŸ“‹ EVENT PAYLOAD SUMMARY:');
            console.log('-'.repeat(30));

            // Log key payload information based on event type
            const payload = context.payload;

            // Common fields for all events
            if (payload.repository) {
              console.log(`ğŸ“¦ Repository: ${payload.repository.full_name}`);
              console.log(`ğŸ”’ Private: ${payload.repository.private}`);
            }

            if (payload.sender) {
              console.log(`ğŸ‘¤ Sender: ${payload.sender.login} (${payload.sender.type})`);
            }

            // Event-specific logging
            switch (context.eventName) {
              case 'push':
                console.log(`ğŸ“¤ Pushed to: ${payload.ref}`);
                console.log(`ğŸ“Š Commits: ${payload.commits?.length || 0}`);
                if (payload.commits && payload.commits.length > 0) {
                  console.log('ğŸ“ Recent commits:');
                  payload.commits.slice(0, 3).forEach(commit => {
                    console.log(`  - ${commit.id.substring(0, 7)}: ${commit.message.split('\n')[0]}`);
                  });
                }
                break;

              case 'pull_request':
                if (payload.pull_request) {
                  const pr = payload.pull_request;
                  console.log(`ğŸ”¢ PR #${pr.number}: "${pr.title}"`);
                  console.log(`ğŸ“ State: ${pr.state} (${pr.draft ? 'Draft' : 'Ready'})`);
                  console.log(`ğŸ‘¤ Author: ${pr.user.login}`);
                  console.log(`ğŸ“‚ Branches: ${pr.head.ref} â†’ ${pr.base.ref}`);
                  console.log(`ğŸ·ï¸  Labels: ${(pr.labels || []).map(l => l.name).join(', ') || 'None'}`);
                  console.log(`âœ… Mergeable: ${pr.mergeable}`);
                  console.log(`ğŸ“Š Commits: ${pr.commits}, Changed files: ${pr.changed_files}`);
                }
                break;

              case 'issue_comment':
              case 'pull_request_review_comment':
                if (payload.comment) {
                  console.log(`ğŸ’¬ Comment by: ${payload.comment.user.login}`);
                  console.log(`ğŸ“ Comment preview: ${(payload.comment.body || '').substring(0, 100)}...`);
                  console.log(`ğŸ”— Comment URL: ${payload.comment.html_url}`);
                }
                if (payload.issue) {
                  console.log(`ğŸ“‹ Issue/PR #${payload.issue.number}: "${payload.issue.title}"`);
                }
                break;

              case 'issues':
                if (payload.issue) {
                  console.log(`ğŸ“‹ Issue #${payload.issue.number}: "${payload.issue.title}"`);
                  console.log(`ğŸ·ï¸  Labels: ${(payload.issue.labels || []).map(l => l.name).join(', ') || 'None'}`);
                  console.log(`ğŸ“Š State: ${payload.issue.state}`);
                }
                break;

              case 'release':
                if (payload.release) {
                  console.log(`ğŸš€ Release: ${payload.release.tag_name}`);
                  console.log(`ğŸ“ Title: ${payload.release.name}`);
                  console.log(`ğŸ“‹ Draft: ${payload.release.draft}, Pre-release: ${payload.release.prerelease}`);
                  console.log(`ğŸ”— Release URL: ${payload.release.html_url}`);
                }
                break;

              case 'workflow_run':
                console.log(`âš™ï¸  Workflow: ${payload.workflow?.name || 'Unknown'}`);
                console.log(`ğŸƒ Run: ${payload.workflow_run?.run_number || 'N/A'}`);
                console.log(`ğŸ“Š Conclusion: ${payload.workflow_run?.conclusion || 'N/A'}`);
                break;

              case 'schedule':
                console.log(`â° Scheduled run`);
                break;

              default:
                console.log(`ğŸ“‹ Event type: ${context.eventName}`);
                // Log some generic payload keys
                const keys = Object.keys(payload).slice(0, 10);
                console.log(`ğŸ”‘ Payload keys: ${keys.join(', ')}`);
            }

            console.log('\nğŸ” RAW PAYLOAD SIZE:');
            console.log('-'.repeat(30));
            const payloadSize = JSON.stringify(payload).length;
            console.log(`ğŸ“ Payload size: ${payloadSize} characters`);
            console.log(`ğŸ“Š Approximate size: ${(payloadSize / 1024).toFixed(2)} KB`);

            console.log('\nâœ… DEBUG LOGGING COMPLETE');
            console.log('='.repeat(50));

      - name: Log Workflow Context
        run: |
          echo "ğŸ”§ WORKFLOW CONTEXT:"
          echo "Event: ${{ github.event_name }}"
          echo "Actor: ${{ github.actor }}"
          echo "Repository: ${{ github.repository }}"
          echo "Ref: ${{ github.ref }}"
          echo "SHA: ${{ github.sha }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Run Number: ${{ github.run_number }}"

      - name: Log Environment Variables
        run: |
          echo "ğŸŒ ENVIRONMENT VARIABLES:"
          echo "CI: $CI"
          echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          echo "GITHUB_EVENT_NAME: $GITHUB_EVENT_NAME"
          echo "GITHUB_EVENT_PATH: $GITHUB_EVENT_PATH"
          echo "GITHUB_REPOSITORY: $GITHUB_REPOSITORY"
          echo "GITHUB_RUN_ID: $GITHUB_RUN_ID"
