name: Release Please

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'docs/**'
      - 'README.md'
      - 'replit.md'
      - '**/*.md'
      - '.gitignore'
      - 'components.json'
      - 'tsconfig.check.json'

permissions:
  contents: write
  pull-requests: write
  actions: write
  checks: write
  statuses: write

jobs:
  # Pre-validation veloce per commit che potrebbero creare release
  pre-validation:
    if: |
      contains(github.event.head_commit.message, 'feat:') ||
      contains(github.event.head_commit.message, 'feat(') || 
      contains(github.event.head_commit.message, 'fix:') || 
      contains(github.event.head_commit.message, 'fix(') || 
      contains(github.event.head_commit.message, 'BREAKING CHANGE')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      validation_passed: ${{ steps.validation.outputs.passed }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Quick validation before release
        id: validation
        run: |
          npm run check
          npm run test:smart
          echo "passed=true" >> $GITHUB_OUTPUT

  # Release Please - Solo creazione/aggiornamento PR
  release-please:
    needs: [pre-validation]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      prs_created: ${{ steps.release.outputs.prs_created }}
      pr: ${{ steps.release.outputs.pr }}
      prs: ${{ steps.release.outputs.prs }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
      html_url: ${{ steps.release.outputs.html_url }}
      pre_validation_passed: ${{ needs.pre-validation.outputs.validation_passed == 'true' }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          release-type: node
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Debug release outputs
        env:
          RELEASE_CREATED: ${{ steps.release.outputs.release_created }}
          PRS_CREATED: ${{ steps.release.outputs.prs_created }}
          PR_OUTPUT: ${{ steps.release.outputs.pr }}
          PRS_OUTPUT: ${{ steps.release.outputs.prs }}
          TAG_NAME: ${{ steps.release.outputs.tag_name }}
          VERSION: ${{ steps.release.outputs.version }}
          HTML_URL: ${{ steps.release.outputs.html_url }}
          VALIDATION_PASSED: ${{ needs.pre-validation.outputs.validation_passed }}
        run: |
          echo "DEBUG: release action outputs"
          echo "steps.release.outputs.release_created=$RELEASE_CREATED"
          echo "steps.release.outputs.prs_created=$PRS_CREATED"
          echo "steps.release.outputs.pr=$PR_OUTPUT"
          echo "steps.release.outputs.prs=$PRS_OUTPUT"
          echo "steps.release.outputs.tag_name=$TAG_NAME"
          echo "steps.release.outputs.version=$VERSION"
          echo "steps.release.outputs.html_url=$HTML_URL"
          echo "needs.pre-validation.outputs.validation_passed=$VALIDATION_PASSED"

      - name: Comment on created PR with validation status
        if: needs.pre-validation.outputs.validation_passed == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Try to get PR number from release-please v4 outputs
            const prsCreated = `${{ steps.release.outputs.prs_created }}`.trim();
            const prsOutput = `${{ steps.release.outputs.prs }}`.trim();
            const prOutput = `${{ steps.release.outputs.pr }}`.trim();
            let prNumber = '';

            // Extract PR number from structured outputs
            if (prsCreated === 'true' && prsOutput) {
              try {
                const prs = JSON.parse(prsOutput);
                if (Array.isArray(prs) && prs.length > 0) {
                  prNumber = prs[0].number;
                  console.log(`Found PR #${prNumber} from prs output (${prs.length} PRs total)`);
                }
              } catch (e) {
                console.log('Failed to parse steps.release.outputs.prs:', e.message);
              }
            } else if (prOutput) {
              try {
                const pr = JSON.parse(prOutput);
                if (pr && pr.number) {
                  prNumber = pr.number;
                  console.log(`Found PR #${prNumber} from pr output`);
                }
              } catch (e) {
                console.log('Failed to parse steps.release.outputs.pr:', e.message);
              }
            }

            if (!prNumber) {
              console.log('No PR number found in release-please outputs; skipping comment.');
              return;
            }

            const comment = `âœ… **Pre-validation passed** - This PR is ready for auto-merge
             
             ðŸ“‹ **Validation Results:**
             - âœ… TypeScript check passed
             - âœ… Smart tests passed
             - ðŸ¤– Auto-merge will proceed when this PR is ready
             
             Once merged, deployment will start automatically.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });

  # Deploy immediato se release Ã¨ giÃ  stata creata (caso edge)
  deploy-if-release-created:
    needs: [release-please]
    if: needs.release-please.outputs.release_created == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check prerequisites
        run: npm run check:prerequisites

      - name: Run type checking
        run: npm run check

      - name: Run complete test suite (ALL tests for production deploy)
        run: npm run test:run

      - name: Generate comprehensive coverage report
        run: npm run test:coverage

      - name: Build application with version
        run: npm run build:prod

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_LECCE_DIGITAL_LEGENDS }}'
          channelId: live
          projectId: lecce-digital-legends

      - name: Create deployment comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tag = '${{ needs.release-please.outputs.tag_name }}';
            const version = '${{ needs.release-please.outputs.version }}';
            const releaseUrl = '${{ needs.release-please.outputs.html_url }}';
            const deployUrl = 'https://lecce-digital-legends.web.app';

            const deploymentInfo = `ðŸš€ **Release ${tag} Deployed Successfully!**

            ## ðŸ“¦ Deployment Details
            - **Live Application**: [${deployUrl}](${deployUrl})
            - **Release Tag**: [\`${tag}\`](${releaseUrl})
            - **Version**: \`${version}\`
            - **Deployed At**: ${new Date().toISOString()}
            - **Commit SHA**: \`${context.sha.substring(0, 7)}\`

            ## ðŸŽ¯ Release Information  
            - **GitHub Release**: [View Release Notes](${releaseUrl})
            - **Changelog**: Updated automatically with conventional commits
            - **Tag Created**: âœ… \`${tag}\` available in repository

            ## ðŸŽ‰ Status
            âœ… **All systems operational** - Release is live and available to users!

            ---
            *Automated deployment completed via Release workflow*`;

            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: deploymentInfo
            });
